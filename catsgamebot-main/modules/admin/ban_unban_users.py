# modules/admin/ban_unban_users.py

from aiogram import Router, types
from aiogram import F
from aiogram.fsm.context import FSMContext
from config import users_collection  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –≥–æ—Ç–æ–≤—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
from .panel import AdminState, is_admin

router = Router()

@router.message(F.text == "üö´ –ó–∞–±–∞–Ω–∏—Ç—å –∏–≥—Ä–æ–∫–∞")
async def ban_user(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return
    await message.answer("–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å:\n–ü—Ä–∏–º–µ—Ä: <code>12345</code>")
    await state.set_state(AdminState.await_ban)

@router.message(F.text == "‚úÖ –†–∞–∑–±–∞–Ω–∏—Ç—å –∏–≥—Ä–æ–∫–∞")
async def unban_user(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return
    await message.answer("–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–±–∞–Ω–∏—Ç—å:\n–ü—Ä–∏–º–µ—Ä: <code>12345</code>")
    await state.set_state(AdminState.await_unban)

@router.message(AdminState.await_ban)
async def handle_ban(message: types.Message, state: FSMContext):
    try:
        # –ü–æ–ª—É—á–∞–µ–º ID –∏–≥—Ä–æ–∫–∞
        uid = int(message.text.strip())

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º ID
        user = await users_collection.find_one({"user_id": uid})
        if not user:
            await message.answer(f"‚ùå –û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {uid} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        # –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –Ω–∞–π–¥–µ–Ω
        result = await users_collection.update_one(
            {"user_id": uid},
            {"$set": {"banned": True}}
        )

        if result.matched_count == 0:
            await message.answer(f"‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID {uid}.")
        else:
            await message.answer(f"üö´ –ò–≥—Ä–æ–∫ —Å ID {uid} –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–±–∞–Ω–µ–Ω.")

    except ValueError:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —á–∏—Å–ª–æ–≤–æ–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
    except Exception as e:
        await message.answer(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
    finally:
        await state.clear()

@router.message(AdminState.await_unban)
async def handle_unban(message: types.Message, state: FSMContext):
    try:
        # –ü–æ–ª—É—á–∞–µ–º ID –∏–≥—Ä–æ–∫–∞
        uid = int(message.text.strip())

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º ID
        user = await users_collection.find_one({"user_id": uid})
        if not user:
            await message.answer(f"‚ùå –û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {uid} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        # –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –Ω–∞–π–¥–µ–Ω
        result = await users_collection.update_one(
            {"user_id": uid},
            {"$set": {"banned": False}}
        )

        if result.matched_count == 0:
            await message.answer(f"‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID {uid}.")
        else:
            await message.answer(f"‚úÖ –ò–≥—Ä–æ–∫ —Å ID {uid} –±—ã–ª —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–±–∞–Ω–µ–Ω.")

    except ValueError:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —á–∏—Å–ª–æ–≤–æ–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
    except Exception as e:
        await message.answer(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
    finally:
        await state.clear()
